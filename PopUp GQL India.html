<!-- PopUp GQL India -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (window?.shouldShowExpertInsight() !== true) {
      document.querySelectorAll(".web_near_form_india .step_indicator_4, .web_near_form_india .selected_time_slot").forEach(item => {
        item.style.display = "none";
      })
    }

    document.querySelectorAll('.web_near_close').forEach(item => {
      item.addEventListener('click', function () {
        document?.querySelector(".web_near_form_india").setAttribute('show_status', false);
      })
    })

    {
      const gqlRgPopup = document?.querySelector(".web_near_form_india .gql_registration_popup_india");

      // 1st step
      const gqlWorkExperience = gqlRgPopup?.querySelector("#gql_experience");
      const gqlDomainRole = gqlRgPopup?.querySelector("#gql_domain_role");
      const gqlIsStudent = gqlRgPopup?.querySelector("#gql_pp_student_flag");
      const gqlLaidOff = gqlRgPopup?.querySelector("#gql_pp_laidoff_flag");

      const gqlLinkdinUrl = gqlRgPopup?.querySelector("#gql_linkdin_pr_link");
      const gqlResume = gqlRgPopup?.querySelector("#gql_get_resume");

      const gqlWrErrDiv = gqlRgPopup?.querySelector(".gql_exp_fild");
      const gqlDmErrDiv = gqlRgPopup?.querySelector(".gql_domain_role_fild");
      const gqlLnErrDiv = gqlRgPopup?.querySelector(".gql_link_din_url");
      const gqlResumeErrDiv = gqlRgPopup?.querySelector(".gql_resume");

      const gqlStartIn = gqlRgPopup?.querySelector("#gql_Start_Interviewing");
      const gqlStartErrDiv = gqlRgPopup?.querySelector(".gql_start_interviewing_fild");



      let gqlResumeBase64String = null;

      let maxSize = 4 * 1024 * 1024;
      const urlRegex = /^(https?:\/\/)?([\w.-]+)\.([a-z]{2,6})(\/[\w.-]*)*\/?$/i;

      gqlResume.addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
          gqlRgPopup.querySelector(".up_load_titile").innerHTML = `Selected: ${file.name}`;
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = function () {
            gqlResumeBase64String = reader.result.split(',')[1];
          };
          reader.onerror = function (error) {
            console.log("Error: ", error);
          };

          if (maxSize < file.size) {
            gqlResumeErrDiv.setAttribute("err_status", true);
          } else {
            gqlResumeErrDiv.setAttribute("err_status", false);
          }
        }
      });

      gqlLinkdinUrl.addEventListener("input", function () {
        if (gqlLinkdinUrl.value.trim() === "" || urlRegex.test(gqlLinkdinUrl.value)) {
          gqlLnErrDiv.setAttribute("err_status", false);
        } else {
          gqlLnErrDiv.setAttribute("err_status", true);
        }
      })

      function getAPIDetails() {
        //if url contains wpcomstaging than send staging api key & url
        if (window.location.href.includes("wpcomstaging")) {
          return {
            url: "https://jobxp11m92.execute-api.us-west-1.amazonaws.com/qa/expert-insights",
            api_key: "Dn6VOF9g4iGtLJLqMBrL2uNWwhfadgl2kXEIvzQ4"
          }
        } else {
          return {
            url: "https://4nwgymw1h6.execute-api.us-west-1.amazonaws.com/api/expert-insights",
            api_key: "fBF1GVnYKb1hReCbCfrQu7zBt4RgLOvh6inYzYqB"
          }
        }
      }

      async function pushGqlPopupFromData() {
        let GqldataPayload = {
          "Lead_Created_Time": webNearInfo.leadCreatedTime,
          "Page_URL": encodeURIComponent(webNearInfo.page_url),
          "First Name": webNearInfo.firstName,
          "Last Name": webNearInfo.lastName,
          "Email Address": webNearInfo.emailAddress,
          "utm_source": webNearInfo.utm_source,
          "utm_medium": webNearInfo.utm_medium,
          "utm_campaign": webNearInfo.utm_campaign,
          "utm_term": webNearInfo.utm_term,
          "gclid": webNearInfo.gclid,
          "msclkid": webNearInfo.msclkid,
          "fbclid": webNearInfo.fbclid,
          "user_id": webNearInfo.user_id,
          "user_timezone": webNearInfo.user_timezone,
          "v_country": webNearInfo.v_country,
          "phone_number_full": webNearInfo.fPhoneNumber,
          "Event Start Time": webNearInfo.eventStartTime,
          "Event End Time": webNearInfo.eventEndTime,
          "Work Experience": gqlWorkExperience.value,
          "Role Domain": gqlDomainRole.value,
          "PA Consult Time": "",
          "PA Consult Time Other": "",
          "Interview Start Time": (webinarType == "SWITCH_UP") ? '' : gqlStartIn.value,
          "Future Plan": (webinarType == "SWITCH_UP") ? gqlStartIn.value : '',
          "Laid Off": gqlLaidOff.checked,
          "Is Student": gqlIsStudent.checked,
          "Domain Switch": "",
          "salesforce_uuid": webNearInfo.salesforce_uuid,
          "linkedin_url": gqlLinkdinUrl.value.trim() || null,
          "resume": gqlResumeBase64String || null,
          "slot": gqlRgPopup?.querySelector(".preferred_time_slot:checked").value,
          "test_group": "B", // will always be B because this code is only for expert insight.
        }
        console.log("optio:", GqldataPayload);
        let options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': getAPIDetails().api_key },
          body: JSON.stringify(GqldataPayload),
        };

        try {
          const sendData = await fetch(getAPIDetails().url, options); // staging url
          return sendData;
        } catch (err) {
          console.error("GQL Failed", err);
          throw err; // Re-throw original error to preserve context for Sentry
        }
      }

      gqlWorkExperience.addEventListener("change", function () {
        gqlWrErrDiv.setAttribute("err_status", false);
      })

      gqlDomainRole.addEventListener("change", function () {
        gqlDmErrDiv.setAttribute("err_status", false);
      })

      gqlStartIn.addEventListener("change", function () {
        gqlStartErrDiv.setAttribute("err_status", false);
      })

      function gqlPopup1stStep() {
        let err = false;
        console.log("gqlPopup1stStep called");
        if (!gqlWorkExperience.value) {
          err = true;
          gqlWrErrDiv.setAttribute("err_status", err);
        }

        if (!gqlDomainRole.value) {
          err = true;
          gqlDmErrDiv.setAttribute("err_status", err);
        }

        if (!gqlStartIn.value) {
          err = true;
          gqlStartErrDiv.setAttribute("err_status", err);
          return;
        }

        if (!err) {
          gqlZapSend();
          if (window?.shouldShowExpertInsight() !== true) {
            let getMarked = document.querySelector(".web_near_form_india .v2_slot_radio:checked");
            document.querySelector(".web_near_form_india #gql_rg_date").innerHTML = formatDate(new Date(getMarked.value));
            document.querySelector(".web_near_form_india").setAttribute("complete_stauts", true);
          } else {
            gqlRgPopup.setAttribute("ac_step", 2);
          }

        }
      }

      gqlRgPopup?.querySelector(".gql_step_1_btn").addEventListener("click", gqlPopup1stStep);
      gqlRgPopup?.querySelector(".gql_popup_stage_1 .gql_btn_back").addEventListener("click", function () {
        document.querySelector(".web_near_form_india").setAttribute("gql_status", false);
      });


      gqlRgPopup?.querySelector(".gql_step_2_btn").addEventListener("click", function () {
        if (gqlResumeErrDiv.getAttribute("err_status") === "true" || gqlLnErrDiv.getAttribute("err_status") === "true") return; // validation for resume
        // Get LinkedIn URL and resume values
        const linkedInValue = gqlLinkdinUrl.value.trim();
        const resumeValue = gqlResumeBase64String;
        // Only make API call if at least one is provided
        if (linkedInValue || resumeValue) {
          pushGqlPopupFromData();
        }
        let getMarked = document.querySelector(".web_near_form_india .v2_slot_radio:checked");
        document.querySelector(".web_near_form_india #gql_rg_date").innerHTML = formatDate(new Date(getMarked.value));
        document.querySelector(".web_near_form_india #gql_rg_time").innerHTML = gqlRgPopup?.querySelector(".preferred_time_slot:checked").value.replace(/\s*\(|\)\s*/g, ", ").replace(/,\s*$/, "");
        document.querySelector(".web_near_form_india").setAttribute("complete_stauts", true);
        saveClickActivity("Gql-form-button_finish");
      });
      gqlRgPopup?.querySelector(".gql_popup_stage_2 .gql_btn_back").addEventListener("click", function () {
        gqlRgPopup.setAttribute("ac_step", 1);
      });


      function formatDate(date) {
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        let dayName = days[date.getDay()];
        let day = date.getDate();
        let month = months[date.getMonth()];
        let hours = date.getHours();
        let period = hours >= 12 ? "PM" : "AM";

        // Convert to 12-hour format
        hours = hours % 12 || 12;

        // Add ordinal suffix (st, nd, rd, th)
        let suffix = "th";
        if (day % 10 === 1 && day !== 11) suffix = "st";
        else if (day % 10 === 2 && day !== 12) suffix = "nd";
        else if (day % 10 === 3 && day !== 13) suffix = "rd";

        return `${dayName}, ${day}${suffix} ${month}, ${hours} ${period}`;
      }


      async function gqlZapSend() {
        let fbc = getCookieValue('_fbc');
        const fbp = getCookieValue('_fbp');
        const userAgent = navigator?.userAgent;
        let GQLformData = {
          'First Name': webNearInfo.firstName,
          'Last Name': webNearInfo.lastName,
          'Email Address': webNearInfo.emailAddress,
          utm_source: webNearInfo.utm_source,
          utm_medium: webNearInfo.utm_medium,
          utm_campaign: webNearInfo.utm_campaign,
          utm_term: webNearInfo.utm_term,
          gclid: webNearInfo.gclid,
          msclkid: webNearInfo.msclkid,
          fbclid: webNearInfo.fbclid,
          fbcId: fbc || null,
          fbpId: fbp || null,
          user_agent: userAgent || '',
          user_id: visitor_id,
          user_timezone: v_timezone,
          v_country: v_country,
          "phone_number_full": webNearInfo.fPhoneNumber,
          "Event Start Time": webNearInfo.eventStartTime,
          "Event End Time": webNearInfo.eventEndTime,
          'Work Experience': gqlWorkExperience.value,
          'Role Domain': gqlDomainRole.value,
          // 'PA Consult Time': "",
          // 'PA Consult Time Other': "",
          "Interview Start Time": (webinarType == "SWITCH_UP") ? '' : gqlStartIn.value,
          "Future Plan": (webinarType == "SWITCH_UP") ? gqlStartIn.value : '',
          'Laid Off': gqlLaidOff.checked,
          'Is Student': gqlIsStudent.checked,
          // 'Domain Switch': '',
          salesforce_uuid: webNearInfo.salesforce_uuid,
          "GA_event_id": Date.now(),
          page_url: webNearInfo?.page_url || "",
        };

        try {
          dataLayer.push({
            event: "wordpress_form_submitted",
            formName: "Lead Qualifier Form",
            event_id: GQLformData.GA_event_id,
          })
        } catch (err) {
          saveClickActivity("info_and_gql_update-error-in-data-layer-push");
          console.error("error in data layer push", err);
        }

        // Validate payload before sending
        if (!GQLformData || Object.keys(GQLformData).length === 0 || JSON.stringify(GQLformData) === "{}") {
          throw new Error("Zapier webhook payload is empty");
        }

        let options = {
          method: 'POST',
          mode: "no-cors",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(GQLformData),
        };

        try {
          let response = await fetch(`https://hooks.zapier.com/hooks/catch/11068981/${isDualWebinar ? '34xp8vf' : '34cx4dp'}`, options);
          saveFormEventsActivity("gql");
        } catch (err) {
          console.error("gqlZapSend", err);
        }
      }
    }
  });
</script>