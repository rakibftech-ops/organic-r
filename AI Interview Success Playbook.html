<!-- AI Interview Success Playbook -->
<script>
  let isMasterClassDownloadPage = [
    "ai-interview-success-playbook",
    "software-engineer-ai-question-bank",
    "engineering-manager-ai-question-bank",
    "tpm-ai-question-bank",
    "data-engineer-ai-question-bank",
    "ai-leadership-mock-interview-vault",
    "holiday-giveaway"
  ];
  isMasterClassDownloadPage = isMasterClassDownloadPage.reduce(
    (prev, curr) => prev || location.pathname.includes(curr),
    false
  );

  // Assign lead magnet value.
  let lead_magnet = "";
  if (window.location.href.includes("ai-interview-success-playbook")) {
    lead_magnet = "L10x_AI_Playbook";
  } else if (
    window.location.href.includes("software-engineer-ai-question-bank")
  ) {
    lead_magnet = "L10x_SE_QuestionBank";
  } else if (
    window.location.href.includes("holiday-giveaway")
  ) {
    lead_magnet = "HOLIDAY_OFFER";
  } else if (
    window.location.href.includes("engineering-manager-ai-question-bank")
  ) {
    lead_magnet = "L10x_EM_QuestionBank";
  } else if (window.location.href.includes("data-engineer-ai-question-bank")) {
    lead_magnet = "L10x_DE_QuestionBank";
  } else if (window.location.href.includes("tpm-ai-question-bank")) {
    lead_magnet = "L10x_TPM_QuestionBank";
  } else if (
    window.location.href.includes("ai-leadership-mock-interview-vault")
  ) {
    lead_magnet = "L10X_AI_MockInterview";
  } else {
    lead_magnet = "L10x";
  }

  document.addEventListener("webNearLoaded", () => {
    selectedSlotSet();
  });
  function selectedSlotSet(slotIndex = 0) {
    const dateSuffix = (date) => {
      const suffixes = ["th", "st", "nd", "rd"];
      const v = date % 100;
      return date + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
    };

    const slideField = document.querySelector(".register_time");
    //     const getDayField = document.querySelector("#v2-success-day");
    //     const getDateField = document.querySelector("#v2-success-date");
    //     const getMonthField = document.querySelector("#v2-success-month");
    //     const getTimeField = document.querySelector("#v2-success-time");

    let firstWebinar = webinarSlots[slotIndex];

    const startTime = new Date(firstWebinar.start_time);
    const endTime = new Date(firstWebinar.end_time);

    const formattedDate = startTime.toLocaleDateString("en-US", {
      day: "2-digit",
      month: "short",
    });

    const formattedStartTime = startTime.toLocaleTimeString("en-US", {
      hour: "numeric",
      minute: "2-digit",
      hour12: true,
    });
    const formattedEndTime = endTime.toLocaleTimeString("en-US", {
      hour: "numeric",
      minute: "2-digit",
      hour12: true,
    });

    slideField.querySelector(
      "span"
    ).innerHTML = `${formattedDate}, ${formattedStartTime} - ${formattedEndTime} PST`;
    document.querySelector(
      ".page_date_show span.elementor-icon-list-text"
    ).innerHTML = `${formattedDate}, ${formattedStartTime} - ${formattedEndTime} PST`;
    slideField.setAttribute("data-start_time", firstWebinar.start_time);
    slideField.setAttribute("data-endtime", firstWebinar.end_time);
    slideField.setAttribute(
      "data-invitee_starttime",
      firstWebinar.invitee_start_time
    );
    slideField.setAttribute(
      "data-invitee_endtime",
      firstWebinar.invitee_end_time
    );

    //     try {
    //       getDayField.innerHTML = startTime.toLocaleDateString("en-US", {
    //         weekday: "long",
    //       });
    //       getDateField.innerHTML = dateSuffix(startTime.getDate());
    //       getMonthField.innerHTML = startTime.toLocaleDateString("en-US", {
    //         month: "long",
    //       });
    //       getTimeField.innerHTML = `${formattedStartTime}`;
    //     } catch (err) {
    //       console.error("Error setting time field", err);
    //     }

    if (isMasterClassDownloadPage) {
      try {
        document.querySelector(".sday").innerHTML = startTime
          .toLocaleDateString("en-US", { weekday: "long" })
          .slice(0, 3);
        document.querySelector(".sdate").innerHTML = dateSuffix(
          startTime.getDate()
        );
        document.querySelector(".smonth").innerHTML =
          startTime.toLocaleDateString("en-US", { month: "long" });
        document.querySelector(".stime").innerHTML = `${formattedStartTime}`;
      } catch (err) {
        console.error("Error setting masterclass download page fields", err);
      }
    }
  }
</script>

<script>
  if (isMasterClassDownloadPage) {
    document.addEventListener("webNearLoaded", function () {
      const mainConatiner = document.querySelector(".v2_from_wrapper2");
      const slideField = mainConatiner.querySelector(".slot_fild");
      slideField.innerHTML = "";
      webinarSlots.forEach(function (slot, index) {
        let createWebinarSlots = document.createElement("label");
        createWebinarSlots.classList.add("slot");
        const startTime = new Date(slot.start_time);
        const formattedStartTime = startTime.toLocaleTimeString("en-US", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });

        let slotInner = `
                    <input type="radio" 
                    name="v2_slot" 
                    class="v2_slot_radio"
                    value="${slot.start_time}"
                    data-endtime="${slot.end_time}" 
                    data-invitee_starttime="${slot.invitee_start_time}" 
                    data-invitee_endtime="${slot.invitee_end_time}" 
                    data-name="${slot.start_time}" 
                    data-webinar_lead_type="${slot.webinar_lead_type}" 
                    ${index === 0 ? "checked" : ""}
                    slot-index="${index}" >
                    <div class="time_slot_wrapper">
                        <div class="v2_day">${startTime
            .toLocaleDateString("en-US", { weekday: "long" })
            .slice(0, 3)
            .toUpperCase()}</div>
                        <div class="v2_date">${startTime.getDate()}</div>
                        <hr>
                        <div class="v2_time">${formattedStartTime}</div>
                    </div>
  
            `;

        if (index === 0) {
          slotInner += `
                    <div class="v2_timer_alart" alart_type="warning">
                        Filling fast
                    </div>
                `;
        } else if (slot.weekday === "Saturday") {
          slotInner += `
                    <div class="v2_timer_alart" alart_type="danger">
                        Almost full
                    </div>
                `;
        }

        createWebinarSlots.innerHTML = slotInner;
        slideField.appendChild(createWebinarSlots);
      });
    });
  }

  // Form send
  window.addEventListener("DOMContentLoaded", function () {
    const getThePopupFrom2 = document.querySelector(".v2_from_wrapper");

    const webNearFullName2 = getThePopupFrom2.querySelector("input.fr_name_fl");
    const webNearEmailAddress2 = getThePopupFrom2.querySelector(".fr_email_fl");
    const webNearPhoneNumber2 = getThePopupFrom2.querySelector(".fr_phone_fl");
    const webNearSlots2 = getThePopupFrom2.querySelector(
      ".slot_sl_con .slot_fild"
    );

    const webNearPhoneNumberWri2 = window.intlTelInput(webNearPhoneNumber2, {
      initialCountry: "auto",
      geoIpLookup: function (callback) {
        fetch("https://ipinfo.io", { headers: { Accept: "application/json" } })
          .then((resp) => resp.json())
          .then((resp) => {
            callback(resp.country);
          })
          .catch((error) => {
            console.error("Error in geoIpLookup", error);
            callback("in");
          });
      },
      utilsScript:
        "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
    });

    document.querySelector(
      ".v2_from_wrapper2 .time_zone"
    ).innerHTML = `Time Zone: ${v_timezone}`;

    // Check the Button text
    const checkboxWrapper = getThePopupFrom2.querySelector(".fr_acceptance");
    if (checkboxWrapper) {
      checkboxWrapper.style.display = "none";
    }
    //     getThePopupFrom2.querySelector(".step_btn_3").innerHTML = "Access Resource";
    const stepBtn3 = getThePopupFrom2.querySelector(".step_btn_3");
    if (window.location.href.includes("holiday-giveaway")) {
      stepBtn3.innerHTML = "Enter the Giveaway ->";
    } else {
      stepBtn3.innerHTML = "Access Resource";
    }
    const exploreBtn = document.querySelector(
      "#explore-project .elementor-button-text"
    );
    exploreBtn?.closest(".elementor-element")?.remove();
    const recordingBtn = document.getElementById("watch_recording_btn");
    if (recordingBtn) {
      const recordingText = recordingBtn.querySelector(
        ".elementor-button-text"
      );
      if (recordingText) {
        recordingText.textContent = "Access Resource";
      }
      recordingBtn.href = "https://www.youtube.com/watch?v=qDqLtlBd818";
    }
    const unlockedHeading = document.querySelector(
      "#recording-unlocked .elementor-heading-title"
    );
    if (unlockedHeading) {
      unlockedHeading.textContent = "Resource Unlocked! ðŸ”“";
    }

    const getFnErrMsg2 = getThePopupFrom2.querySelector(".v2_full_name");
    const getEmErrMsg2 = getThePopupFrom2.querySelector(".v2_email");
    const getPhErrMsg2 = getThePopupFrom2.querySelector(".v2_phone_number");

    document
      .querySelector(".data_web_near_close")
      .addEventListener("click", function () {
        document
          .querySelector(".complete_message")
          .setAttribute("show_status", false);
        document.querySelector(".pr_yr_exp").setAttribute("show_status", false);
        getThePopupFrom2.setAttribute("active_step", 1);
      });

    // name container
    const webNearInfo2 = {
      firstName: "",
      lastName: "",
      fPhoneNumber: "",
      utm_source: "",
      utm_medium: "",
      utm_campaign: "",
      utm_adset: "",
      utm_content: "",
      utm_term: "",
      page_url: page_url,
      site_url: window.location.hostname,
      user_id: "",
      gclid: "",
      salesforce_uuid: "",
      msclkid: "",
      fbclid: "",
      fbcId: null,
      fbpId: null,
      userAgent: "",
      li_fat_id: "",
      user_timezone: "",
      l_page_url: "",
      cta_page_url: "",
      webinar_type: webinarType, //TODO: get this from wp
      eventname: "",
      wr__referrer: "",
      wr__device: "",
      webinar_lead_type: webinarType, //TODO: get this from wp
      bye_calendly_type: "",
      is_exit_intent_popup: "",
      v_country: "",
      wr__region: "",
      wr__city: "",
      irclickid: "",

      eventStartTime: "",
      eventEndTime: "",
      inviteStartTime: "",
      inviteEndTime: "",
    };

    //check regex
    let name_regex2 = new RegExp("^[a-zA-Z ]+$");
    let email_regex2 = EMAIL_REGEX;
    let phone_regex2 =
      /^(\+\d{1,2}\s?)?1?\-?\.?\s?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/;

    // getlocation json
    (async function () {
      let response = await fetch("https://get.geojs.io/v1/ip/geo.json");
      let data = await response.json();
      webNearInfo2.v_country = data.country;
      webNearInfo2.wr__region = data.region;
      webNearInfo2.wr__city = data.city;
    })();

    function getCookieValue(cookieName) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${cookieName}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
    }

    function setHiddenFields2() {
      //  let params = read_cookie("v_latest");
      function getParams(t) {
        var t = t ? t.split("?")[1] : window.location.search.slice(1),
          r = {};
        if (t)
          for (
            var s = (t = t.split("#")[0]).split("&"), e = 0;
            e < s.length;
            e++
          ) {
            var a,
              n = s[e].split("="),
              i = n[0],
              o = void 0 === n[1] ? void 0 : n[1];
            (i = i.toLowerCase()).match(/\[(\d+)?\]$/)
              ? (r[(a = i.replace(/\[(\d+)?\]/, ""))] || (r[a] = []),
                i.match(/\[\d+\]$/)
                  ? ((n = /\[(\d+)\]/.exec(i)[1]), (r[a][n] = o))
                  : r[a].push(o))
              : r[i]
                ? ("string" == typeof r[i] && (r[i] = [r[i]]), r[i].push(o))
                : (r[i] = o);
          }
        return r;
      }
      let params = [];
      try {
        params = read_cookie("v_latest") || getParams();
        bake_cookie("v_latest", params);
      } catch (error) {
        console.error("Error while reading cookie", error);
      }

      const fbcFromCookies = getCookieValue("_fbc");
      const fbp = getCookieValue("_fbp");
      const userAgent = navigator?.userAgent;
      const fbclid = decodeURIComponent(params["fbclid"] || "");
      let fbc = fbcFromCookies;
      if (!fbcFromCookies && fbclid) {
        // Generate fbc from fbclid
        const domainParts = window.location.hostname.split(".");
        const subdomainIndex = domainParts.length - 1;
        const creationTime = Date.now();
        fbc = `fb.${subdomainIndex}.${creationTime}.${fbclid}`;
      }

      webNearInfo2.utm_source = decodeURIComponent(
        params["utm_source"] || "Organic"
      );
      webNearInfo2.utm_medium = decodeURIComponent(params["utm_medium"] || "");
      webNearInfo2.utm_campaign = decodeURIComponent(
        params["utm_campaign"] || ""
      );
      webNearInfo2.utm_content = decodeURIComponent(
        params["utm_content"] || ""
      );
      webNearInfo2.utm_term = decodeURIComponent(params["utm_term"] || "");
      webNearInfo2.utm_adset = decodeURIComponent(params["utm_adset"] || "");
      webNearInfo2.gclid = decodeURIComponent(params["utm_term"] || "");
      webNearInfo2.salesforce_uuid = decodeURIComponent(
        params["salesforce_uuid"] || ""
      );
      webNearInfo2.msclkid = decodeURIComponent(params["msclkid"] || "");
      webNearInfo2.fbclid = fbclid;
      webNearInfo2.fbcId = fbc || null;
      webNearInfo2.fbpId = fbp || null;
      (webNearInfo2.userAgent = userAgent),
        (webNearInfo2.li_fat_id = decodeURIComponent(
          params["li_fat_id"] || ""
        ));

      webNearInfo2.user_id = visitor_id;
      webNearInfo2.user_timezone = v_timezone;
      //     webNearInfo2.l_page_url = "learn.ik" + getCookie("ik-landingpage");
      if ((referrer || "") != "") {
        webNearInfo2.l_page_url = "ik/" + (referrer || "").split("/").pop();
      } else {
        webNearInfo2.l_page_url = "ik/" + page_url.split("/").pop();
      }
      webNearInfo2.cta_page_url = "ik" + cta_lp;
      webNearInfo2.webinar_type = webinarType; //TODO: get this from wp
      webNearInfo2.eventname = eventName;
      webNearInfo2.wr__referrer = referrer;
      webNearInfo2.wr__device = getDeviceType();

      webNearInfo2.webinar_lead_type = webinarType; //TODO: get this from wp
      webNearInfo2.bye_calendly_type = "";
      webNearInfo2.is_exit_intent_popup = "No";
      webNearInfo2.irclickid = decodeURIComponent(params["irclickid"] || "");
    }
    setHiddenFields2();

    async function pushToEndPoint2(endpoint, step) {
      let currentWebinarType = webinarType;
      let curreventName = eventName;

      let getCheckWebnear = document.querySelector(".register_time");
      webNearInfo2.eventStartTime =
        getCheckWebnear.getAttribute("data-start_time");
      webNearInfo2.eventEndTime = getCheckWebnear.getAttribute("data-endtime");
      webNearInfo2.inviteStartTime = getCheckWebnear.getAttribute(
        "data-invitee_starttime"
      );
      webNearInfo2.inviteEndTime = getCheckWebnear.getAttribute(
        "data-invitee_endtime"
      );
      //   i

      let formData = {
        "First Name": webNearInfo2.firstName,
        "Last Name": webNearInfo2.lastName,
        "Email Address": webNearEmailAddress2.value,
        ByeCalendlyType: webNearInfo2.bye_calendly_type,
        "webinar-type": currentWebinarType, //TODO: get this from wp
        "Webinar Lead Type": currentWebinarType, //TODO: get this from wp
        utm_source: webNearInfo2.utm_source,
        utm_medium: webNearInfo2.utm_medium,
        utm_campaign: webNearInfo2.utm_campaign,
        utm_content: webNearInfo2.utm_content,
        utm_adset: webNearInfo2.utm_adset,
        utm_term: webNearInfo2.utm_term,

        City: webNearInfo2.wr__city,
        Device: webNearInfo2.wr__device,
        Referrer: webNearInfo2.wr__referrer,
        Region: webNearInfo2.wr__region,

        gclid: webNearInfo2.gclid,
        msclkid: webNearInfo2.msclkid,
        fbclid: webNearInfo2.fbclid,
        fbpId: webNearInfo2.fbpId,
        fbcId: webNearInfo2.fbcId,
        user_agent: webNearInfo2.userAgent,
        user_id: webNearInfo2.user_id,
        li_fat_id: webNearInfo2.li_fat_id,

        cta_page_url: webNearInfo2.cta_page_url,
        landing_page_url: webNearInfo2.l_page_url,
        event_name: curreventName,
        user_timezone: webNearInfo2.user_timezone,
        page_url: webNearInfo2.page_url,
        site_url: webNearInfo2.site_url,
        v_country: webNearInfo2.v_country,
        salesforce_uuid: webNearInfo2.salesforce_uuid,
        phone_number_full: webNearInfo2.fPhoneNumber,
        is_exit_intent_popup: webNearInfo2.is_exit_intent_popup,
        irclickid: webNearInfo2.irclickid,

        "Event Start Time": webNearInfo2.eventStartTime,
        "Event End Time": webNearInfo2.eventEndTime,
        "Invitee Start Time": webNearInfo2.inviteStartTime,
        "Invitee End Time": webNearInfo2.inviteEndTime,
        lead_magnet: lead_magnet,
        ...userIpAndBrowserInfo,
      };

      // Validate payload before sending
      if (!formData || Object.keys(formData).length === 0 || JSON.stringify(formData) === "{}") {
        throw new Error("Zapier webhook payload is empty");
      }

      let options = {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      };

      try {
        const sendData = await fetch(endpoint, options);
        return sendData;
      } catch (err) {
        console.error("P0: The Zapier Webhook Failed.", err);
      }
    }

    function hideError2() {
      getFnErrMsg2.setAttribute("err_status", false);
      getEmErrMsg2.setAttribute("err_status", false);
      getPhErrMsg2.setAttribute("err_status", false);
    }

    // First Form Submittion
    function fromSend1stStep2() {
      function track(step, message) {
        typeof saveFormEventsActivity === "function"
          ? saveFormEventsActivity(step, null, null, message)
          : console.error("saveFormEventsActivity is not a function");
      }
      setHiddenFields2();

      let fullname = webNearFullName2.value.trim();
      let wEmail = webNearEmailAddress2.value;
      let fullPhoneNumber = webNearPhoneNumber2.value;

      //Hide errors
      webNearFullName2.addEventListener("input", hideError2);
      webNearEmailAddress2.addEventListener("input", hideError2);
      webNearPhoneNumber2.addEventListener("input", hideError2);
      webNearFullName2.addEventListener("focus", hideError2);
      webNearEmailAddress2.addEventListener("focus", hideError2);
      webNearPhoneNumber2.addEventListener("focus", hideError2);

      //Error check
      if (
        fullname.length == 0 &&
        wEmail.length == 0 &&
        fullPhoneNumber.length == 0
      ) {
        getFnErrMsg2.setAttribute("err_status", true);
        getEmErrMsg2.setAttribute("err_status", true);
        getPhErrMsg2.setAttribute("err_status", true);
        track("info-e", "validation-general");
        return;
      } else if (!name_regex2.test(fullname) || fullname.length == 0) {
        getFnErrMsg2.setAttribute("err_status", true);
        track("info-e", "validation-name");
        return;
      } else if (fullname.length > 31) {
        const errMsgElement = getFnErrMsg2.querySelector(".err_fild");
        getFnErrMsg2.setAttribute("err_status", true);
        errMsgElement.innerHTML = `<b>â“˜</b> Full Name cannot exceed 31 characters.`;
        track("info-e", "validation-name-length");
        return;
      } else if (!email_regex2.test(wEmail) || wEmail.length == 0) {
        getEmErrMsg2.setAttribute("err_status", true);
        track("info-e", "validation-email");
        return;
      } else if (
        !phone_regex2.test(fullPhoneNumber) ||
        fullPhoneNumber.length == 0
      ) {
        getPhErrMsg2.setAttribute("err_status", true);
        track("info-e", "validation-phone");
        return;
      } else {
        if (fullname.substring(0, fullname.indexOf(" ")) == "") {
          webNearInfo2.firstName = fullname.substring(
            fullname.indexOf(" ") + 1
          );
          webNearInfo2.lastName = fullname.substring(fullname.indexOf(" ") + 1);
        } else if (fullname.substring(fullname.indexOf(" ") + 1) == "") {
          webNearInfo2.firstName = fullname.substring(0, fullname.indexOf(" "));
          webNearInfo2.lastName = fullname.substring(0, fullname.indexOf(" "));
        } else {
          webNearInfo2.firstName = fullname.substring(0, fullname.indexOf(" "));
          webNearInfo2.lastName = fullname.substring(fullname.indexOf(" ") + 1);
        }

        try {
          dataLayer.push({
            event: "pa_new_webinar_registration_form_submitted",
            webinar_name: webNearInfo.eventname,
          });
        } catch (err) {
          console.error("Error in dataLayer push", err);
        }

        // webNearInfo2.fPhoneNumber = webNearPhoneNumberWri2.getNumber(intlTelInputUtils.numberFormat.E164);
        webNearInfo2.fPhoneNumber = "";
        if (typeof intlTelInputUtils == "undefined") {
          try {
            webNearInfo2.fPhoneNumber = `+${webNearPhoneNumberWri2.getSelectedCountryData().dialCode || ""
              }${document.querySelector(".fr_phone_fl")?.value}`;
          } catch (error) {
            console.error("Error while getting phone number", error);
            webNearInfo2.fPhoneNumber =
              document.querySelector(".fr_phone_fl")?.value;
          }
        } else {
          webNearInfo2.fPhoneNumber = webNearPhoneNumberWri2.getNumber(
            intlTelInputUtils.numberFormat.E164
          );
        }

        let zapUrl = "https://hooks.zapier.com/hooks/catch/11068981/27cwi2a/";

        try {
          document.querySelector(".first_name_loader span").innerHTML =
            webNearInfo2.firstName;
        } catch (err) {
          console.error("Error setting first name loader", err);
        }

        if (
          window.location.href.includes(
            "/guide/ai-interview-success-playbook"
          ) ||
          window.location.href.includes(
            "/question-bank/software-engineer-ai-question-bank"
          ) ||
          window.location.href.includes(
            "/holiday-giveaway"
          ) ||
          window.location.href.includes(
            "/question-bank/engineering-manager-ai-question-bank"
          ) ||
          window.location.href.includes(
            "/question-bank/tpm-ai-question-bank"
          ) ||
          window.location.href.includes(
            "/question-bank/data-engineer-ai-question-bank"
          ) ||
          window.location.href.includes(
            "/guide/ai-leadership-mock-interview-vault"
          )
        ) {
          pushToEndPoint2(zapUrl)
            .then(() => {
              track("info");
              // try {
              //     fromSend2ndStep2();
              // } catch (error) {
              //     track("slot-e", "flow-zapier");
              // }
              getThePopupFrom2.setAttribute("active_step", 3);
            })
            .catch((error) => {
              console.error("Error in pushToEndPoint2", error);
              track("info-e", "flow-zapier");
            });
        } else {
          new Promise((res) => res())
            .then(() => {
              track("info");
              try {
                fromSend2ndStep2();
              } catch (error) {
                console.error("Error in fromSend2ndStep2", error);
                track("slot-e", "flow-zapier");
              }
              getThePopupFrom2.setAttribute("active_step", 3);
            })
            .catch((error) => {
              console.error("Error in pushToEndPoint2", error);
              track("info-e", "flow-zapier");
            });
        }
      }
    }

    // Second Form Submition
    function fromSend2ndStep2() {
      function track(step, message) {
        typeof saveFormEventsActivity === "function"
          ? saveFormEventsActivity(step, null, null, message)
          : console.error("saveFormEventsActivity is not a function");
      }
      const getCheckWebnear = document.querySelector(".register_time");

      let utmm = visitor_id + ":" + webNearInfo2.v_country;
      let sf_uuid =
        v_timezone + ":ik" + cta_lp + ":ik" + getCookie("ik-landingpage");
      webNearInfo2.salesforce_uuid = sf_uuid;
      let utmstring = {
        assigned_to: "Interview Kickstart",
        invitee_first_name: webNearInfo2.firstName,
        invitee_last_name: webNearInfo2.lastName,
        invitee_email: webNearEmailAddress2.value,
        answer_1: webNearInfo2.fPhoneNumber,
        event_start_time: getCheckWebnear.getAttribute("data-start_time"),
        event_end_time: getCheckWebnear.getAttribute("data-endtime"),
        utm_medium: utmm,
        salesforce_uuid: sf_uuid,
      };

      bake_cookie("from_cookie", utmstring);

      //   let pushUrl = v_country === "India" ? "https://hooks.zapier.com/hooks/catch/11068981/340hl1a/" : "https://hooks.zapier.com/hooks/catch/11068981/340hl1a/";
      //let pushUrl = v_country === "India" ? "" : "";
      let pushUrl = "https://hooks.zapier.com/hooks/catch/11068981/34cq9f8/";
      pushToEndPoint2(pushUrl);
      // if (v_country === "India") {
      //     pushToEndPoint2(pushUrl);
      // }
      new Promise((res) => res())
        .then(() => {
          getThePopupFrom2.setAttribute("active_step", 3);
          secondStepSecondRequest2();
          track("slot");
        })
        .catch((err) => {
          console.error("Error in pushToEndPoint2 (step 2)", err);
          track("slot-e", "flow-zapier");
        });
    }

    const getWorkExperience = getThePopupFrom2.querySelector(".gql_exp_select");
    const getDomainRole = getThePopupFrom2.querySelector(".gql_domain_select");
    const getStartIn = getThePopupFrom2.querySelector(".gql_int_select");
    const getCurrentGoal = getThePopupFrom2.querySelector(
      ".gql_int_select_org"
    );
    const getIsStudent = getThePopupFrom2.querySelector(
      ".v2-checkbox-is-student"
    );
    const getIsLaidOff = getThePopupFrom2.querySelector(
      ".v2-checkbox-is-laidoff"
    );

    const errWorkEx = getThePopupFrom2.querySelector(".v2_exp_fild");
    const errDomEx = getThePopupFrom2.querySelector(".v2_dom_fild");
    const errInEx = getThePopupFrom2.querySelector(".v2_int_fild");

    getWorkExperience.addEventListener("change", function () {
      errWorkEx.setAttribute("err_status", false);
    });

    getDomainRole.addEventListener("change", function () {
      errDomEx.setAttribute("err_status", false);
    });

    getStartIn.addEventListener("change", function () {
      errInEx.setAttribute("err_status", false);
    });

    getCurrentGoal.addEventListener("change", function () {
      errInEx.setAttribute("err_status", false);
    });

    function fromSend3rdStep2(sbFrEx = false) {
      let v2WorkExp = getWorkExperience.value;
      let v2DomExp = getDomainRole.value;
      let v2StarExp = v_country === "India" ? getStartIn.value : true;
      let v2IsStudent = getIsStudent.checked;
      let v2IsLaidOff = getIsLaidOff.checked;

      let gqlErrStatus = false;

      if (!v2WorkExp) {
        gqlErrStatus = true;
        errWorkEx.setAttribute("err_status", gqlErrStatus);
      }
      if (!v2DomExp) {
        gqlErrStatus = true;
        errDomEx.setAttribute("err_status", gqlErrStatus);
      }
      if (!v2StarExp && !isMasterClassDownloadPage) {
        gqlErrStatus = true;
        errInEx.setAttribute("err_status", gqlErrStatus);
      }

      if (!gqlErrStatus) {
        function track(step, message) {
          typeof saveFormEventsActivity === "function"
            ? saveFormEventsActivity(step, null, null, message)
            : console.error("saveFormEventsActivity is not a function");
        }

        let GQLformData = {
          "First Name": webNearInfo2.firstName,
          "Last Name": webNearInfo2.lastName,
          "Email Address": webNearEmailAddress2.value,
          utm_source: webNearInfo2.utm_source,
          utm_medium: webNearInfo2.utm_medium,
          utm_campaign: webNearInfo2.utm_campaign,
          utm_term: webNearInfo2.utm_term,
          gclid: webNearInfo2.gclid,
          msclkid: webNearInfo2.msclkid,
          fbclid: webNearInfo2.fbclid,
          fbpId: webNearInfo2.fbpId,
          fbcId: webNearInfo2.fbcId,
          user_agent: webNearInfo2.userAgent,
          user_id: visitor_id,
          user_timezone: v_timezone,
          v_country: v_country,
          phone_number_full: webNearInfo2.fPhoneNumber,
          "Event Start Time": webNearInfo2.eventStartTime,
          "Event End Time": webNearInfo2.eventEndTime,
          "Work Experience": v2WorkExp,
          "Role Domain": v2DomExp,
          // 'PA Consult Time': "",
          // 'PA Consult Time Other': "",
          "Interview Start Time": getStartIn.value,
          "Current Goal": getCurrentGoal.value,
          "Laid Off": v2IsLaidOff,
          "Is Student": v2IsStudent,
          salesforce_uuid: webNearInfo2.salesforce_uuid,
          event_name: webNearInfo2.eventName,
          webinar_type: webinarType, //TODO: get this from wp
          page_url: webNearInfo2?.page_url || "",
          event_start_time: webNearInfo2.eventStartTime,
          CTA_Page: encodeURIComponent(webNearInfo2?.cta_page_url || ""),
          lead_magnet: lead_magnet,
          GA_event_id: Date.now(),
        };

        try {
          dataLayer.push({
            event: "wordpress_form_submitted",
            formName: "Lead Qualifier Form",
            page_category: "l10x",
            event_id: GQLformData.GA_event_id,
          });
        } catch (err) {
          console.error("Data Layer add failed", err);
        }
        let zapUrl = "https://hooks.zapier.com/hooks/catch/11068981/2eumu4v/";

        if (sbFrEx) {
          zapUrl = "https://hooks.zapier.com/hooks/catch/11068981/2q1a52r/";
          GQLformData.masterclass_lead_intent = Array.from(
            document.querySelectorAll(".per_checkBox:checked")
          )
            .map((x) => x.value)
            .join(",");
        }

        if (v_country === "India") {
          zapUrl = "https://hooks.zapier.com/hooks/catch/11068981/2eumu4v/";
        }
        sendRequestZapiar(zapUrl, GQLformData, track, sbFrEx);
      } else {
        track("gql-e", "flow-general");
      }
    }

    async function sendRequestZapiar(url, data, callback, sbFrEx = false) {
      // Validate payload before sending
      if (!data || (typeof data === 'object' && Object.keys(data).length === 0) || JSON.stringify(data) === "{}") {
        throw new Error("Zapier webhook payload is empty");
      }

      let options = {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      };

      try {
        let response = await fetch(url, options);
        if (
          (window.location.href.includes(
            "/guide/ai-interview-success-playbook"
          ) ||
            window.location.href.includes(
              "/question-bank/software-engineer-ai-question-bank"
            ) ||
            window.location.href.includes(
              "/holiday-giveaway"
            ) ||
            window.location.href.includes(
              "/question-bank/engineering-manager-ai-question-bank"
            ) ||
            window.location.href.includes(
              "/question-bank/tpm-ai-question-bank"
            ) ||
            window.location.href.includes(
              "/question-bank/data-engineer-ai-question-bank"
            ) ||
            window.location.href.includes(
              "/guide/ai-leadership-mock-interview-vault"
            )) &&
          !sbFrEx
        ) {
          document
            .querySelector(".pr_yr_exp")
            .setAttribute("show_status", true);
        } else {
          document
            .querySelector(".pr_yr_exp")
            .setAttribute("show_status", false);
          document
            .querySelector(".complete_message")
            .setAttribute("show_status", true);
        }
        if (typeof callback === "function") {
          callback("gql");
        }
      } catch (error) {
        if (typeof callback === "function") {
          callback("gql-e", "Zapier Webhook Failed");
        }
        console.error("error in zapier webhook", error);
      }
    }

    async function secondStepSecondRequest2() {
      const getCheckWebnear = document.querySelector(".register_time");

      //lead LeadCreatedTime
      const currentDateTime = new Date();
      const LeadCreatedTime = currentDateTime
        .toISOString()
        .replace(/T/, " ")
        .replace(/\.\d+Z$/, " UTC");

      function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        const year = date.getUTCFullYear();
        const month = (date.getUTCMonth() + 1).toString().padStart(2, "0");
        const day = date.getUTCDate().toString().padStart(2, "0");
        const hours = date.getUTCHours().toString().padStart(2, "0");
        const minutes = date.getUTCMinutes().toString().padStart(2, "0");
        const seconds = date.getUTCSeconds().toString().padStart(2, "0");
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
      }

      const formattedStartDateTime = formatDateTime(
        getCheckWebnear.getAttribute("data-start_time")
      );
      const formattedEndDateTime = formatDateTime(
        getCheckWebnear.getAttribute("data-endtime")
      );

      let data = [
        {
          Lead_Created_Time: LeadCreatedTime,
          Lead_Name: webNearInfo2.firstName + " " + webNearInfo2.lastName,
          Lead_First_Name: webNearInfo2.firstName,
          Lead_Last__Name: webNearInfo2.lastName,
          Lead_Email: webNearEmailAddress2.value,
          Lead_Time_Zone: webNearInfo2.user_timezone,
          Event_Type_Name: eventName,
          Event_Start_Date_Time: formattedStartDateTime,
          Event_End_Date_Time: formattedEndDateTime,
          Cancellation_reason: "",
          Mobile: webNearInfo2.fPhoneNumber,
          UTM_Campaign: webNearInfo2.utm_campaign,
          UTM_Source: webNearInfo2.utm_source,
          UTM_Medium: webNearInfo2.utm_medium,
          UTM_Term: webNearInfo2.utm_term,
          UTM_Content: webNearInfo2.utm_content,
          Tracking_ID: "",
          User_ID: webNearInfo2.user_id,
          Page_URL: encodeURIComponent(webNearInfo2.page_url),
          Country: webNearInfo2.v_country,
          Client_Timezone: webNearInfo2.user_timezone,
          CTA_Page: encodeURIComponent(webNearInfo2.cta_page_url),
          Landing_Page: encodeURIComponent(webNearInfo2.l_page_url),
          Webinar_reg_type: "",
          Webinar_Type: webinarType, //TODO: get this from wp
          Switchup_Lead: webinarType, //TODO: get this from wp
          UUID: webNearInfo2.salesforce_uuid,
          Click_History: "",
          City: webNearInfo2.wr__city,
          Device: webNearInfo.wr__device,
          User_Agent: encodeURIComponent(navigator?.userAgent || ""),
          Refferer: encodeURIComponent(webNearInfo2.wr__referrer),
          Region: webNearInfo2.wr__region,
          step: "s4",
        },
      ];

      let options = {
        method: "POST",
        keepalive: true,
        headers: {
          "x-api-key": "fm0X61U99b80d5SlGjrxFaWjgxIBylhX3LkfYGPN",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          dataset_id: "Marketing_data_new_logic",
          table_id: "Leads_Click_history",
          data: data,
        }),
      };

      try {
        const response = await fetch(
          "https://nlhtyrnugl.execute-api.us-west-1.amazonaws.com/prod",
          options
        );
        return response;
      } catch (err) {
        console.error("Error in secondStepSecondRequest2", err);
      }
    }

    const getV2Btn1 = getThePopupFrom2.querySelector(".step_btn_1");
    const getV2Btn2 = getThePopupFrom2.querySelector(".step_btn_2");
    const getV2Btn3 = getThePopupFrom2.querySelector(".step_btn_3");

    const getV2Back2 = getThePopupFrom2.querySelector(".step_back_2");
    const getV2Back3 = getThePopupFrom2.querySelector(".step_back_3");

    getV2Btn1.addEventListener("click", () => {
      try {
        fromSend1stStep2();
      } catch (error) {
        console.error("Error in 1st step", error);
        saveFormEventsActivity("info-e", null, null, "Error in 1st step");
      }
    });
    getV2Btn3.addEventListener("click", () => {
      try {
        fromSend3rdStep2();
        document
          .querySelector(".video_container")
          .setAttribute("show_status", true);

        // start the timer after button click
        const duration = 30; // seconds
        let timeLeft = duration;
        const circle = document.querySelector(".circle-progress");

        if (circle) {
          const timeText = document.getElementById("time-text");
          const timer = document.getElementById("timer");
          const radius = 54;
          const circumference = 2 * Math.PI * radius;

          circle.style.strokeDasharray = circumference;

          function updateTimer() {
            const offset =
              circumference - (timeLeft / duration) * circumference;
            circle.style.strokeDashoffset = offset;

            const minutes = Math.floor(timeLeft / 60)
              .toString()
              .padStart(2, "0");
            const seconds = (timeLeft % 60).toString().padStart(2, "0");
            timeText.textContent = `${minutes}:${seconds}`;

            if (timeLeft <= 0) {
              clearInterval(timerInterval);
              showCheckmark();
            }

            timeLeft--;
          }

          function showCheckmark() {
            const isHolidayGiveaway = window.location.href.includes("holiday-giveaway");
            const message = isHolidayGiveaway
              ? "You've entered the Giveaway. We'll get in touch with you over email soon.<br>Happy HolidaysðŸŽ„"
              : "Thanks for your patience. Your resource has been delivered to your email.";
            document.querySelector(".countdown-wrapper").innerHTML = `
                      <div class="checkmark">
                      <svg xmlns="http://www.w3.org/2000/svg" width="68" height="68" viewBox="0 0 68 68" fill="none">
                      <circle cx="33.8645" cy="33.8645" r="33.8645" fill="#8FFFDD" fill-opacity="0.4"/>
                      <rect x="9.64062" y="9.78058" width="48" height="48" rx="24" fill="#8FFFDD"/>
                      <path d="M41.0251 28.2421L30.8712 38.396L26.2559 33.7806" stroke="#1B5B48" stroke-width="2.30769" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      </div>
                      <div class="title-loader">${message}</div>
          `;
          }

          updateTimer(); // Initialize
          const timerInterval = setInterval(updateTimer, 1000);
        }
      } catch (error) {
        console.error("Error in 3rd step", error);
        saveFormEventsActivity("gql-e", null, null, "Error in 3rd step");
      }
    });

    getV2Back2.addEventListener("click", function () {
      getThePopupFrom2.setAttribute("active_step", 1);
    });
    getV2Back3.addEventListener("click", function () {
      getThePopupFrom2.setAttribute("active_step", 1);
    });

    // // Personalize Your Experience Buttons
    // const prExSubmit = document.querySelector('.pr_yr_exp_submit_button');
    // const prExSkip = document.querySelector('.pr_yr_exp_skip_button');

    // prExSubmit.addEventListener("click", () => {
    //     try {
    //         fromSend3rdStep2(true);
    //     } catch (error) {
    //         saveFormEventsActivity("gql-e", null, null, "Error in 3rd step");
    //     }
    // });

    // prExSkip.addEventListener("click", function () {
    //     document.querySelector(".complete_message").setAttribute('show_status', true);
    // })

    if (isMasterClassDownloadPage) {
      document
        .querySelector(".pr_yr_exp_submit_button")
        .addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          //   document.querySelector(".video_container").setAttribute('show_status', true);
        });

      const form2Selet = document.querySelector(".v2_from_wrapper2");
      console.log("form2Selet", form2Selet);
      form2Selet
        .querySelector(".step_submit_btn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          let selectedSlotNumber = parseInt(
            form2Selet.querySelector("input:checked").getAttribute("slot-index")
          );

          // pushToEndPoint2("https://hooks.zapier.com/hooks/catch/11068981/34cq9f8/", 3);

          selectedSlotSet(selectedSlotNumber);
          fromSend2ndStep2();
          form2Selet.setAttribute("active_step", 3);
        });

      // "What is your current goal?" quation add
      // -----------------Start------------------
      document.body.setAttribute("webinarType", webinarType);
      document.body.setAttribute("country", v_country);

      function reliventSlotLoad() {
        const allSlots = {};
        return async function (currentWebinarType) {
          webinarType = currentWebinarType;
          if (allSlots[currentWebinarType]) {
            webinarSlots = allSlots[currentWebinarType];
            return webinarSlots;
          }
          let api_url = `https://uplevel.interviewkickstart.com/api/webinar-slot/upcoming-slots/?country=USA&program=Backend&timezone=${v_timezone?.replace(
            "+",
            "%2B"
          )}&type=${currentWebinarType}`;
          const option = {
            method: "GET",
            headers: {
              Authorization: "1Cgx6oYXkOlWkNDn7_tXO",
            },
          };
          const response = await fetch(api_url, option);
          const data = await response.json();
          const resobj = data.map((item) => ({
            ...item,
            webinar_lead_type: webinarType,
          }));
          allSlots[currentWebinarType] = resobj;
          webinarSlots = resobj;
          return webinarSlots;
        };
      }

      let reliventSlotLoadFunc = reliventSlotLoad();
      let defafultWebinarType = webinarType;

      document.querySelectorAll(".v2_int_fild").forEach((item) => {
        const getSelectFild = item.querySelector(".gql_int_select_org");

        getSelectFild.addEventListener("change", function () {
          webinarType =
            getSelectFild.selectedOptions[0].getAttribute("webinarType") ||
            defafultWebinarType;
          document.body.setAttribute("webinarType", webinarType);
          eventName = getEventTitle(webinarType);
          //                     if(!pageEnventName) {
          //                         eventName = getEventTitle(webinarType);
          //                     }

          reliventSlotLoadFunc(webinarType).then((x) => {
            document.dispatchEvent(webNearLoadedEv);
          });
        });
      });
      // -----------------End------------------
    }
  });
</script>